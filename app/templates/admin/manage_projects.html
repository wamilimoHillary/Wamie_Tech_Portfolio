{% extends "admin/admin_base.html" %}

{% block title %}Project Management{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/colors.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/user_management.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin_forms.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@400;700&family=Dancing+Script:wght@400;700&display=swap" rel="stylesheet">
{% endblock %}

{% block admin_content %}
<div class="admin-container" style="margin:5px;">
  <section class="user-management">
    <h2>Project Management</h2>

<div class="add-btn-container">
        <button id="add-project-btn" class="add-btn"><i class="fas fa-plus"></i> Add Project</button>
      </div>

    <div class="wrap-items">
      <div class="user-search-bar">
        <form method="GET">
          <input type="text" id="search-bar" name="search" placeholder="Search projects by name or status...">
          <button type="submit" class="search-btn">Search</button>
        </form>
      </div>

      
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="flash-messages">
      {% for category, message in messages %}
      <div class="flash {{ category }}">{{ message }}</div>
      {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <!-- Projects Table -->
    <table class="user-table">
      <thead>
        <tr>
          <th>No</th>
          <th>Project Name</th>
          <th>Description</th>
          <th>Status</th>
          <th>Link</th>
          <th>Created At</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for project in projects %}
        <tr>
          <td>{{ loop.index }}</td>
          <td>{{ project[1] }}</td>
          <td>{{ project[2] }}</td>
          <td>{{ project[3] }}</td>
          <td><a href="{{ project[4] }}" target="_blank">View</a></td>
          <td>{{ project[5] }}</td>
          <td class="action">
            <button class="edit-btn"
                    data-id="{{ project[0] }}"
                    data-name="{{ project[1] }}"
                    data-description="{{ project[2] }}"
                    data-status="{{ project[3] }}"
                    data-link="{{ project[4] }}">
              <i class="fas fa-edit"></i> Edit
            </button>
            <button class="delete-btn"
                    data-id="{{ project[0] }}"
                    onclick="openDeleteModal('{{ project[0] }}')">
              <i class="fas fa-trash"></i> Delete
            </button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>
</div>

<!-- Add Project Modal -->
<div id="add-project-modal" class="modal">
  <div class="modal-content">
    <span class="close-btn">&times;</span>
    <h2 class="form-title">Add Project</h2>
    <form action="{{ url_for('admin.add_project') }}" method="POST" class="form">
      <div class="form-group">
        <label class="form-label" for="add-project-name">Project Name</label>
        <input type="text" name="project_name" id="add-project-name" class="form-input" required>
      </div>
      <div class="form-group">
        <label class="form-label" for="add-project-description">Description</label>
        <textarea name="project_description" id="add-project-description" class="form-input" required></textarea>
      </div>
      <div class="form-group">
        <label class="form-label" for="add-project-status">Status</label>
        <select name="project_status" id="add-project-status" class="form-input" required>
          <option value="Active">Active</option>
          <option value="Completed">Completed</option>
          <option value="Pending">Pending</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label" for="add-project-link">Project Link</label>
        <input type="url" name="project_link" id="add-project-link" class="form-input">
      </div>
      <button type="submit" class="form-button">Add Project</button>
    </form>
  </div>
</div>

<!-- Edit Project Modal -->
<div id="update-project-modal" class="modal">
  <div class="modal-content">
    <span class="close-btn">&times;</span>
    <h2 class="form-title">Edit Project</h2>
    <form action="{{ url_for('admin.update_project') }}" method="POST" class="form">
      <input type="hidden" name="project_id" id="project-id">
      <div class="form-group">
        <label class="form-label" for="project-name">Project Name</label>
        <input type="text" name="project_name" id="project-name" class="form-input" required>
      </div>
      <div class="form-group">
        <label class="form-label" for="project-description">Description</label>
        <textarea name="project_description" id="project-description" class="form-input" required></textarea>
      </div>
      <div class="form-group">
        <label class="form-label" for="project-status">Status</label>
        <select name="project_status" id="project-status" class="form-input" required>
          <option value="Active">Active</option>
          <option value="Completed">Completed</option>
          <option value="Pending">Pending</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label" for="project-link">Project Link</label>
        <input type="url" name="project_link" id="project-link" class="form-input">
      </div>
      <button type="submit" class="form-button">Update</button>
    </form>
  </div>
</div>

<!-- Delete Project Modal -->
<div id="delete-project-modal" class="modal">
  <div class="modal-content">
    <span class="close-btn">&times;</span>
    <h2 class="form-title">Confirm Delete</h2>
    <p>Are you sure you want to delete this project?</p>
    <form action="{{ url_for('admin.delete_project') }}" method="POST" class="form">
      <input type="hidden" name="project_id" id="delete-project-id">
      <button type="submit" class="form-button danger">Delete</button>
      <button type="button" class="form-button" onclick="closeDeleteModal()">Cancel</button>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
/* ================================
   🎯 Modal + Form Interactions
   ================================ */
document.querySelectorAll('.edit-btn').forEach(button => {
  button.addEventListener('click', function() {
    const modal = document.getElementById('update-project-modal');
    modal.classList.add('show');
    document.getElementById('project-id').value = this.dataset.id;
    document.getElementById('project-name').value = this.dataset.name;
    document.getElementById('project-description').value = this.dataset.description;
    document.getElementById('project-status').value = this.dataset.status;
    document.getElementById('project-link').value = this.dataset.link;
  });
});

function openDeleteModal(id) {
  document.getElementById('delete-project-id').value = id;
  document.getElementById('delete-project-modal').classList.add('show');
}

function closeDeleteModal() {
  document.getElementById('delete-project-modal').classList.remove('show');
}

document.querySelectorAll('.close-btn').forEach(btn => {
  btn.addEventListener('click', () => btn.closest('.modal').classList.remove('show'));
});

window.addEventListener('click', e => {
  document.querySelectorAll('.modal').forEach(m => {
    if (e.target === m) m.classList.remove('show');
  });
});

document.getElementById('add-project-btn').addEventListener('click', () => {
  document.getElementById('add-project-modal').classList.add('show');
});

/* ================================
   🔍 Live Search (Instant Filter)
   ================================ */
const searchInput = document.getElementById('search-bar');
const tableBody = document.querySelector('.user-table tbody');

searchInput.addEventListener('input', function() {
  const filter = this.value.trim().toLowerCase();
  const rows = tableBody.querySelectorAll('tr');
  rows.forEach(row => {
    const cells = row.querySelectorAll('td');
    let matchFound = false;
    cells.forEach(cell => {
      if (cell.textContent.trim().toLowerCase().includes(filter)) {
        matchFound = true;
      }
    });
    row.style.display = matchFound ? '' : 'none';
  });
});
</script>
{% endblock %}
