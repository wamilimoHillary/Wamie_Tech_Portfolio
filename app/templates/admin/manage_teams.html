{% extends "admin/admin_base.html" %}

{% block title %}Team Management{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/colors.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/user_management.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin_forms.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@400;700&family=Dancing+Script:wght@400;700&display=swap" rel="stylesheet">
{% endblock %}

{% block admin_content %}
<div class="admin-container" style="margin:5px;">
  <section class="user-management">
    <h2>Team Management</h2>

    <div class="add-btn-container">
        <button id="add-team-btn" class="add-btn"><i class="fas fa-plus"></i> Add Team Member</button>
      </div>

    <div class="wrap-items">
      <div class="user-search-bar">
        <form method="GET">
          <input type="text" id="search-bar" name="search" placeholder="Search team members by name or role...">
          <button type="submit" class="search-btn">Search</button>
        </form>
      </div>

      
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="flash-messages">
      {% for category, message in messages %}
      <div class="flash {{ category }}">{{ message }}</div>
      {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <!-- Teams Table (uses same user-table class as Projects) -->
    <table class="user-table">
      <thead>
        <tr>
          <th>No</th>
          <th>Team Member</th>
          <th>Professionalism</th>
          <th>Role Played</th>
          <th>Image</th>
          <th>Date Added</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for team in teams %}
        <tr>
          <td>{{ loop.index }}</td>
          <td>{{ team[1] }}</td>
          <td>{{ team[2] }}</td>
          <td>{{ team[3] }}</td>
          <td><img src="{{ url_for('static', filename=team[5]) }}" alt="Team Image" style="width:50px;height:50px;border-radius:6px;"></td>
          <td>{{ team[4] }}</td>
          <td class="action">
            <button class="edit-btn"
                    data-id="{{ team[0] }}"
                    data-name="{{ team[1] }}"
                    data-professionalism="{{ team[2] }}"
                    data-role="{{ team[3] }}"
                    data-image="{{ url_for('static', filename=team[5]) }}">
              <i class="fas fa-edit"></i> Edit
            </button>
            <button class="delete-btn"
                    data-id="{{ team[0] }}"
                    onclick="openDeleteModal('{{ team[0] }}')">
              <i class="fas fa-trash"></i> Delete
            </button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>
</div>

<!-- Add Team Modal -->
<div id="add-team-modal" class="modal">
  <div class="modal-content">
    <span class="close-btn">&times;</span>
    <h2 class="form-title">Add Team Member</h2>
    <form action="{{ url_for('admin.add_team') }}" method="POST" enctype="multipart/form-data" class="form">
      <div class="form-group">
        <label class="form-label" for="add-team-name">Team Member Name</label>
        <input type="text" name="team_member_name" id="add-team-name" class="form-input" required>
      </div>
      <div class="form-group">
        <label class="form-label" for="add-team-professionalism">Professionalism</label>
        <input type="text" name="professionalism" id="add-team-professionalism" class="form-input" required>
      </div>
      <div class="form-group">
        <label class="form-label" for="add-team-role">Role Played</label>
        <input type="text" name="role_played" id="add-team-role" class="form-input" required>
      </div>
      <div class="form-group">
        <label class="form-label" for="add-team-image">Upload Image</label>
        <input type="file" name="image_url" id="add-team-image" class="form-input" required>
      </div>
      <button type="submit" class="form-button">Add Team Member</button>
    </form>
  </div>
</div>

<!-- Edit Team Modal -->
<div id="update-team-modal" class="modal">
  <div class="modal-content">
    <span class="close-btn">&times;</span>
    <h2 class="form-title">Edit Team Member</h2>
    <form action="{{ url_for('admin.update_team') }}" method="POST" enctype="multipart/form-data" class="form">
      <input type="hidden" name="team_id" id="team-id">
      <div class="form-group">
        <label class="form-label" for="team-name">Team Member Name</label>
        <input type="text" name="team_member_name" id="team-name" class="form-input" required>
      </div>
      <div class="form-group">
        <label class="form-label" for="team-professionalism">Professionalism</label>
        <input type="text" name="professionalism" id="team-professionalism" class="form-input" required>
      </div>
      <div class="form-group">
        <label class="form-label" for="team-role">Role Played</label>
        <input type="text" name="role_played" id="team-role" class="form-input" required>
      </div>
      <div class="form-group">
        <label class="form-label" for="team-image">Image</label>
        <input type="file" name="image_url" id="team-image" class="form-input">
        <div>
          <img id="image-preview" src="" alt="Current_img" style="max-width: 100px; display: none;">
        </div>
      </div>
      <button type="submit" class="form-button">Update</button>
    </form>
  </div>
</div>

<!-- Delete Team Modal -->
<div id="delete-team-modal" class="modal">
  <div class="modal-content">
    <span class="close-btn">&times;</span>
    <h2 class="form-title">Confirm Delete</h2>
    <p>Are you sure you want to delete this team member?</p>
    <form action="{{ url_for('admin.delete_team') }}" method="POST" class="form">
      <input type="hidden" name="team_id" id="delete-team-id">
      <button type="submit" class="form-button danger">Delete</button>
      <button type="button" class="form-button" onclick="closeDeleteModal()">Cancel</button>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
/* ================================
   ðŸŽ¯ Modal + Form Interactions
   ================================ */
document.querySelectorAll('.edit-btn').forEach(button => {
  button.addEventListener('click', function() {
    const modal = document.getElementById('update-team-modal');
    modal.classList.add('show');

    document.getElementById('team-id').value = this.dataset.id;
    document.getElementById('team-name').value = this.dataset.name;
    document.getElementById('team-professionalism').value = this.dataset.professionalism;
    document.getElementById('team-role').value = this.dataset.role;

    // image dataset contains full url already
    const imageUrl = this.dataset.image || '';
    const preview = document.getElementById('image-preview');
    if (imageUrl) {
      preview.src = imageUrl;
      preview.style.display = 'block';
    } else {
      preview.style.display = 'none';
    }
  });
});

function openDeleteModal(id) {
  document.getElementById('delete-team-id').value = id;
  document.getElementById('delete-team-modal').classList.add('show');
}

function closeDeleteModal() {
  document.getElementById('delete-team-modal').classList.remove('show');
}

document.querySelectorAll('.close-btn').forEach(btn => {
  btn.addEventListener('click', () => btn.closest('.modal').classList.remove('show'));
});

window.addEventListener('click', e => {
  document.querySelectorAll('.modal').forEach(m => {
    if (e.target === m) m.classList.remove('show');
  });
});

document.getElementById('add-team-btn').addEventListener('click', () => {
  document.getElementById('add-team-modal').classList.add('show');
});

/* ================================
   ðŸ” Live Search (Instant Filter)
   ================================ */
const searchInput = document.getElementById('search-bar');
const tableBody = document.querySelector('.user-table tbody');

searchInput.addEventListener('input', function() {
  const filter = this.value.trim().toLowerCase();
  const rows = tableBody.querySelectorAll('tr');
  rows.forEach(row => {
    const cells = row.querySelectorAll('td');
    let matchFound = false;
    cells.forEach(cell => {
      if (cell.textContent.trim().toLowerCase().includes(filter)) {
        matchFound = true;
      }
    });
    row.style.display = matchFound ? '' : 'none';
  });
});
</script>
{% endblock %}
